<!DOCTYPE html>
<html>
<head>
    <title>{{ title }}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .status { font-weight: bold; }
    </style>
</head>
<body>
    <h1>{{ title }}</h1>
    
    <div class="test-section">
        <h2>App Installation Status</h2>
        <p><span class="status success">✓</span> App Name: {{ app_name }}</p>
        <p><span class="status success">✓</span> App Version: {{ app_version }}</p>
    </div>
    
    <div class="test-section">
        <h2>Override Module Import Test</h2>
        {% if override_import_success %}
            <p><span class="status success">✓</span> Override module imported successfully</p>
            <p>Available functions: {{ override_functions|join(", ") }}</p>
        {% else %}
            <p><span class="status error">✗</span> Failed to import override module</p>
            <p>Error: {{ import_error }}</p>
        {% endif %}
    </div>
    
    <div class="test-section">
        <h2>ERPNext Integration Test</h2>
        {% if erpnext_available %}
            <p><span class="status success">✓</span> ERPNext integration working</p>
            <p>Sample Stock DocTypes found: {{ stock_doctypes|length }}</p>
        {% else %}
            <p><span class="status error">✗</span> ERPNext integration failed</p>
            <p>Error: {{ erpnext_error }}</p>
        {% endif %}
    </div>
    
    <div class="test-section">
        <h2>API Test</h2>
        <p>Click the button below to run comprehensive tests via API:</p>
        <button onclick="runApiTest()">Run API Test</button>
        <div id="api-results"></div>
    </div>
    
    <div class="test-section">
        <h2>Manual Test Instructions</h2>
        <ol>
            <li>Go to <strong>Stock > Purchase Receipt</strong></li>
            <li>Create a new Purchase Receipt</li>
            <li>Add an item with a batch that has an expired date</li>
            <li>Try to save - it should work (this is the new behavior)</li>
            <li>Go to <strong>Selling > Sales Invoice</strong></li>
            <li>Try to sell the same expired batch - it should be blocked (safety maintained)</li>
        </ol>
    </div>

    <script>
        function runApiTest() {
            const resultsDiv = document.getElementById('api-results');
            resultsDiv.innerHTML = '<p>Running tests...</p>';
            
            fetch('/api/method/surgishoperpnext.api.test_app.test_app_status')
                .then(response => response.json())
                .then(data => {
                    let html = '<h3>API Test Results:</h3>';
                    
                    for (const [testName, testResult] of Object.entries(data.message.tests)) {
                        const statusClass = testResult.status === 'success' ? 'success' : 
                                          testResult.status === 'warning' ? 'warning' : 'error';
                        
                        html += `<div class="test-section">
                            <h4>${testName.replace(/_/g, ' ').toUpperCase()}</h4>
                            <p><span class="status ${statusClass}">${testResult.status}</span></p>`;
                        
                        if (testResult.error) {
                            html += `<p>Error: ${testResult.error}</p>`;
                        }
                        if (testResult.message) {
                            html += `<p>Message: ${testResult.message}</p>`;
                        }
                        if (testResult.functions_available) {
                            html += `<p>Functions: ${testResult.functions_available.join(', ')}</p>`;
                        }
                        
                        html += '</div>';
                    }
                    
                    resultsDiv.innerHTML = html;
                })
                .catch(error => {
                    resultsDiv.innerHTML = `<p class="error">API Test failed: ${error.message}</p>`;
                });
        }
    </script>
</body>
</html>
