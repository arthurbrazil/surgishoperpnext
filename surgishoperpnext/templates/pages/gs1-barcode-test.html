<!--
SurgiShopERPNext GS1 Barcode Test Page
This page helps test the GS1 barcode scanning functionality
-->

<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h4>üè• SurgiShopERPNext GS1 Barcode Test</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Test GS1 Barcode Scanning</h5>
                            <div class="form-group">
                                <label for="test-barcode">Enter GS1 Barcode (GTIN-01):</label>
                                <input type="text" id="test-barcode" class="form-control barcode-scan" 
                                       placeholder="Enter or scan GS1 barcode here..." />
                            </div>
                            <button class="btn btn-primary" onclick="testBarcodeScan()">
                                Test Barcode Scan
                            </button>
                            <button class="btn btn-secondary" onclick="clearResults()">
                                Clear Results
                            </button>
                        </div>
                        <div class="col-md-6">
                            <h5>Test Results</h5>
                            <div id="test-results" class="alert alert-info">
                                <strong>Ready to test...</strong><br>
                                Enter a GS1 barcode above and click "Test Barcode Scan" or press Enter.
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <h5>Debug Information</h5>
                            <div id="debug-info" class="bg-light p-3" style="max-height: 300px; overflow-y: auto;">
                                <small>Debug information will appear here...</small>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <h5>Sample GS1 Barcodes for Testing</h5>
                            <div class="alert alert-warning">
                                <strong>Note:</strong> These are sample GTIN-01 codes for testing. 
                                Make sure you have items in your system with these barcodes.
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <h6>Sample GTIN-01 Codes:</h6>
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item">01234567890123</li>
                                        <li class="list-group-item">09876543210987</li>
                                        <li class="list-group-item">01111111111111</li>
                                    </ul>
                                </div>
                                <div class="col-md-4">
                                    <h6>Test Actions:</h6>
                                    <button class="btn btn-sm btn-outline-primary" onclick="testWithSample('01234567890123')">
                                        Test Sample 1
                                    </button><br><br>
                                    <button class="btn btn-sm btn-outline-primary" onclick="testWithSample('09876543210987')">
                                        Test Sample 2
                                    </button><br><br>
                                    <button class="btn btn-sm btn-outline-primary" onclick="testWithSample('01111111111111')">
                                        Test Sample 3
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <h6>Debug Controls:</h6>
                                    <button class="btn btn-sm btn-outline-success" onclick="enableDebugMode()">
                                        Enable Debug
                                    </button><br><br>
                                    <button class="btn btn-sm btn-outline-warning" onclick="disableDebugMode()">
                                        Disable Debug
                                    </button><br><br>
                                    <button class="btn btn-sm btn-outline-info" onclick="showScannerStatus()">
                                        Scanner Status
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Test functions for GS1 Barcode Scanner
function testBarcodeScan() {
    const barcode = document.getElementById('test-barcode').value;
    if (!barcode) {
        showResult('Please enter a barcode to test', 'warning');
        return;
    }
    
    showResult('Testing barcode: ' + barcode, 'info');
    addDebugInfo('Testing barcode: ' + barcode);
    
    // Simulate the barcode scan process
    if (window.surgiShopGS1Scanner) {
        window.surgiShopGS1Scanner.processGS1Barcode({ barcode: barcode });
    } else {
        showResult('GS1 Scanner not initialized', 'danger');
        addDebugInfo('ERROR: GS1 Scanner not initialized');
    }
}

function testWithSample(sampleBarcode) {
    document.getElementById('test-barcode').value = sampleBarcode;
    testBarcodeScan();
}

function clearResults() {
    document.getElementById('test-results').innerHTML = '<strong>Ready to test...</strong><br>Enter a GS1 barcode above and click "Test Barcode Scan" or press Enter.';
    document.getElementById('debug-info').innerHTML = '<small>Debug information will appear here...</small>';
    document.getElementById('test-barcode').value = '';
}

function showResult(message, type) {
    const alertClass = 'alert-' + type;
    document.getElementById('test-results').innerHTML = 
        '<div class="alert ' + alertClass + '">' + message + '</div>';
}

function addDebugInfo(message) {
    const debugDiv = document.getElementById('debug-info');
    const timestamp = new Date().toLocaleTimeString();
    debugDiv.innerHTML += '<small>[' + timestamp + '] ' + message + '</small><br>';
    debugDiv.scrollTop = debugDiv.scrollHeight;
}

function enableDebugMode() {
    if (window.surgiShopGS1Scanner) {
        window.surgiShopGS1Scanner.debugMode = true;
        addDebugInfo('Debug mode enabled');
        showResult('Debug mode enabled', 'success');
    } else {
        showResult('GS1 Scanner not initialized', 'danger');
    }
}

function disableDebugMode() {
    if (window.surgiShopGS1Scanner) {
        window.surgiShopGS1Scanner.debugMode = false;
        addDebugInfo('Debug mode disabled');
        showResult('Debug mode disabled', 'info');
    } else {
        showResult('GS1 Scanner not initialized', 'danger');
    }
}

function showScannerStatus() {
    if (window.surgiShopGS1Scanner) {
        const status = {
            initialized: true,
            barkLoaded: window.surgiShopGS1Scanner.barkLoaded,
            debugMode: window.surgiShopGS1Scanner.debugMode,
            excludedDialogs: window.surgiShopGS1Scanner.excludedDialogs
        };
        addDebugInfo('Scanner Status: ' + JSON.stringify(status, null, 2));
        showResult('Scanner Status: ' + JSON.stringify(status, null, 2), 'info');
    } else {
        showResult('GS1 Scanner not initialized', 'danger');
        addDebugInfo('ERROR: GS1 Scanner not initialized');
    }
}

// Listen for Enter key in barcode input
document.getElementById('test-barcode').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        testBarcodeScan();
    }
});

// Initialize debug info
addDebugInfo('GS1 Barcode Test Page loaded');
addDebugInfo('Waiting for GS1 Scanner initialization...');

    // Check if scanner is ready
    setInterval(function() {
        if (window.surgiShopGS1Scanner) {
            addDebugInfo('GS1 Scanner is ready');
            clearInterval(this);
        }
    }, 1000);
    
    // Also check if we're in a supported doctype for testing
    const supportedDoctypes = [
        'Stock Entry', 'Purchase Order', 'Purchase Receipt', 
        'Purchase Invoice', 'Sales Invoice', 'Delivery Note', 
        'Stock Reconciliation'
    ];
    
    let currentDoctype = null;
    if (frappe.get_cur_frm && frappe.get_cur_frm()) {
        currentDoctype = frappe.get_cur_frm().doctype;
    }
    
    if (currentDoctype && supportedDoctypes.includes(currentDoctype)) {
        addDebugInfo('Current doctype is supported for barcode scanning: ' + currentDoctype);
    } else {
        addDebugInfo('Current doctype is not supported for barcode scanning: ' + currentDoctype);
        addDebugInfo('Supported doctypes: ' + supportedDoctypes.join(', '));
    }
</script>

<style>
#debug-info {
    font-family: monospace;
    font-size: 12px;
    line-height: 1.4;
}

.list-group-item {
    font-family: monospace;
    font-size: 14px;
}
</style>

